<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<!--
******************************************************************************
*
******************************************************************************
-->

<html>
<head>
   <title>RHIC Polarimetry Results: Fill Database</title>
   <link REL="STYLESHEET" TYPE="text/css" HREF="../main.css">
</head>

<body bgcolor="#ffffff">

<?php
include("../head.html");
?>


<!-- Main text starts here-->

<p><a name="content"/>

<h1>RHIC Polarimetry Results by Fill</h1>

<?php

include_once("../rundb/DbFillPolar.php");
include_once("../rundb/FillSelector.php");

$fillSelector = new FillSelector();
$fillSelector->PrintForm();

$dbFillPolar = new DbFillPolar($fillSelector);
//$dbFillPolar = new DbFillPolar();

$nFills = $dbFillPolar->CountEntries();

?>

<p>
Fills selected: <?=$dbFillPolar->nResults?>

<?//=$dbFillPolar->sqlWhere?>

<?
// Create page links
//$page = 1;
//$nRunsPerPage = 200;
//$nPages = ceil($nFills/$nRunsPerPage);

//if ( isset($_GET['page']) ) $page = $_GET['page'];
//if ($page > $nPages || $page < 1) $page = 1;

//$dbFillPolar->PrintPageIndex($nPages, $page);

// read all entries for this run period
$entries = $dbFillPolar->ReadEntries(); //($page-1)*$nRunsPerPage, $nRunsPerPage);

//print "<pre>\n";
//print_r($row);
//print "</pre>\n";

$es            = array();
$polarBHJs     = array();
$polarBHJ_B1Us = array();
$polarBHJ_B2Ds = array();
$polarYHJs     = array();
$polarYHJ_Y1Ds = array();
$polarYHJ_Y2Us = array();
$polarB1Us     = array();
$polarY1Ds     = array();
$polarB2Ds     = array();
$polarY2Us     = array();
$polarB1U_BHJs = array();
$polarY1D_YHJs = array();
$polarB2D_BHJs = array();
$polarY2U_YHJs = array();


// First loop over all fills
// Calculate whatever using all fills
while ($e = mysql_fetch_assoc($entries))
{
   // put all entries in array $es for convenience
   $es[] = $e;

   // blue
   if ($e['polar_blue_1_err'] >= 0) {
      $polarB1Us[]    = new pair($e['polar_blue_1'], $e['polar_blue_1_err']);
   }

   if ($e['polar_blue_2_err'] >= 0) {
      $polarB2Ds[]    = new pair($e['polar_blue_2'], $e['polar_blue_2_err']);
   }

   if ( $e['polar_blue_hjet_err'] >= 0 ) {

      $polarBHJs[] = new pair($e['polar_blue_hjet'], $e['polar_blue_hjet_err']);

      if ($e['polar_blue_1_err'] >= 0) {
         $polarBHJ_B1Us[] = new pair($e['polar_blue_hjet'], $e['polar_blue_hjet_err']);
         $polarB1U_BHJs[] = new pair($e['polar_blue_1'],    $e['polar_blue_1_err']);
      }

      if ($e['polar_blue_2_err'] >= 0) {
         $polarBHJ_B2Ds[] = new pair($e['polar_blue_hjet'], $e['polar_blue_hjet_err']);
         $polarB2D_BHJs[] = new pair($e['polar_blue_2'],    $e['polar_blue_2_err']);
      }
   }


   // yellow
   if ($e['polar_yellow_1_err'] >= 0) {
      $polarY1Ds[]    = new pair($e['polar_yellow_1'], $e['polar_yellow_1_err']);
   }

   if ($e['polar_yellow_2_err'] >= 0) {
      $polarY2Us[]    = new pair($e['polar_yellow_2'], $e['polar_yellow_2_err']);
   }

   if ( $e['polar_yellow_hjet_err'] >= 0 ) {

      $polarYHJs[] = new pair($e['polar_yellow_hjet'], $e['polar_yellow_hjet_err']);

      if ($e['polar_yellow_1_err'] >= 0) {
         $polarYHJ_Y1Ds[] = new pair($e['polar_yellow_hjet'], $e['polar_yellow_hjet_err']);
         $polarY1D_YHJs[] = new pair($e['polar_yellow_1'],    $e['polar_yellow_1_err']);
      }

      if ($e['polar_yellow_2_err'] >= 0) {
         $polarYHJ_Y2Us[] = new pair($e['polar_yellow_hjet'], $e['polar_yellow_hjet_err']);
         $polarY2U_YHJs[] = new pair($e['polar_yellow_2'],    $e['polar_yellow_2_err']);
      }
   }
}

// Calculate the average for all sets
$pairBHJ_Avrg     = calcWeigtedAvrgErr($polarBHJs);
$pairBHJ_B1U_Avrg = calcWeigtedAvrgErr($polarBHJ_B1Us);
$pairBHJ_B2D_Avrg = calcWeigtedAvrgErr($polarBHJ_B2Ds);
$pairYHJ_Avrg     = calcWeigtedAvrgErr($polarYHJs);
$pairYHJ_Y1D_Avrg = calcWeigtedAvrgErr($polarYHJ_Y1Ds);
$pairYHJ_Y2U_Avrg = calcWeigtedAvrgErr($polarYHJ_Y2Us);
$pairB1U_Avrg     = calcWeigtedAvrgErr($polarB1Us);
$pairY1D_Avrg     = calcWeigtedAvrgErr($polarY1Ds);
$pairB2D_Avrg     = calcWeigtedAvrgErr($polarB2Ds);
$pairY2U_Avrg     = calcWeigtedAvrgErr($polarY2Us);
$pairB1U_BHJ_Avrg = calcWeigtedAvrgErr($polarB1U_BHJs);
$pairY1D_YHJ_Avrg = calcWeigtedAvrgErr($polarY1D_YHJs);
$pairB2D_BHJ_Avrg = calcWeigtedAvrgErr($polarB2D_BHJs);
$pairY2U_YHJ_Avrg = calcWeigtedAvrgErr($polarY2U_YHJs);

// Calculate scale factors
$normB1U = $pairB1U_BHJ_Avrg->first ? $pairBHJ_B1U_Avrg->first / $pairB1U_BHJ_Avrg->first : 1;
$normY1D = $pairY1D_YHJ_Avrg->first ? $pairYHJ_Y1D_Avrg->first / $pairY1D_YHJ_Avrg->first : 1;
$normB2D = $pairB2D_BHJ_Avrg->first ? $pairBHJ_B2D_Avrg->first / $pairB2D_BHJ_Avrg->first : 1;
$normY2U = $pairY2U_YHJ_Avrg->first ? $pairYHJ_Y2U_Avrg->first / $pairY2U_YHJ_Avrg->first : 1;


// Loop over all fills to find (average/best) missing values
$deltaB_UvsDs = array();
$deltaY_UvsDs = array();
$deltaB_profs = array();
$deltaY_profs = array();

$pairProfileB_Vs = array();
$pairProfileB_Hs = array();
$pairProfileY_Vs = array();
$pairProfileY_Hs = array();

print("<pre>");
//print_r($deltaB_UvsDs);
//print_r($deltaY_UvsDs);
//print_r($pairProfileB_Vs);
//print_r($pairProfileB_Hs);
//print_r($es);
print("</pre>");

print("<pre>");
//print_r($es);
//foreach ($es as $e):
//   print ($e['fill']."\n");
//endforeach;
print("</pre>");

foreach ($es as &$e) {

   // blue comb
   $pairB_UDs = array();
   $pairY_UDs = array();

   if ($e['polar_blue_1_err'] >= 0) {
      // add syst to the stat error
		$err_stat = $normB1U * $e['polar_blue_1_err'];
		$err_syst = $relSystErr["B1U"]["sigma"]["norm"] * $pairBHJ_B1U_Avrg;
		$err = sqrt($err_stat*$err_stat + $err_syst*$err_syst);
      $pairB_UDs[] = new pair($normB1U * $e['polar_blue_1'], $err);
   }

   if ($e['polar_blue_2_err'] >= 0) {
      // add syst to the stat error
		$err_stat = $normB2D * $e['polar_blue_2_err'];
		$err_syst = $relSystErr["B2D"]["sigma"]["norm"] * $pairBHJ_B2D_Avrg;
		$err = sqrt($err_stat*$err_stat + $err_syst*$err_syst);
      $pairB_UDs[] = new pair($normB2D * $e['polar_blue_2'], $err);
   }

   if ($e['polar_yellow_1_err'] >= 0) {
      // add syst to the stat error
		$err_stat = $normY1D * $e['polar_yellow_1_err'];
		$err_syst = $relSystErr["Y1D"]["sigma"]["norm"] * $pairYHJ_Y1D_Avrg;
		$err = sqrt($err_stat*$err_stat + $err_syst*$err_syst);
      $pairY_UDs[] = new pair($normY1D * $e['polar_yellow_1'], $err);
   }

   if ($e['polar_yellow_2_err'] >= 0) {
      // add syst to the stat error
		$err_stat = $normY2U * $e['polar_yellow_2_err'];
		$err_syst = $relSystErr["Y2U"]["sigma"]["norm"] * $pairYHJ_Y2U_Avrg;
		$err = sqrt($err_stat*$err_stat + $err_syst*$err_syst);
      $pairY_UDs[] = new pair($normY2U * $e['polar_yellow_2'], $err);
   }

   $pairB_UD_Avrg  = calcWeigtedAvrgErr( $pairB_UDs );
   $pairY_UD_Avrg  = calcWeigtedAvrgErr( $pairY_UDs );

   //$deltaB_UvsD    = calcMaxDifference($pairB_UD_Avrg, $pairB_UDs);
   //$deltaY_UvsD    = calcMaxDifference($pairY_UD_Avrg, $pairY_UDs);

   //if ($deltaB_UvsD >= 0)
   //   $deltaB_UvsDs[] = $deltaB_UvsD;

   //if ($deltaY_UvsD >= 0)
   //   $deltaY_UvsDs[] = $deltaY_UvsD;

   // now deal with profiles
   $pairProfileB_V = null;
   if ($e['profile_blue_v_err'] >= 0) {
      $pairProfileB_V = new pair($e['profile_blue_v'], $e['profile_blue_v_err']);
      $pairProfileB_Vs[] = $pairProfileB_V;
   }

   $pairProfileB_H = null;
   if ($e['profile_blue_h_err'] >= 0) {
      $pairProfileB_H = new pair($e['profile_blue_h'], $e['profile_blue_h_err']);
      $pairProfileB_Hs[] = $pairProfileB_H;
   }

   $pairProfileY_V = null;
   if ($e['profile_yellow_v_err'] >= 0) {
      $pairProfileY_V = new pair($e['profile_yellow_v'], $e['profile_yellow_v_err']);
      $pairProfileY_Vs[] = $pairProfileY_V;
   }

   $pairProfileY_H = null;
   if ($e['profile_yellow_h_err'] >= 0) {
      $pairProfileY_H = new pair($e['profile_yellow_h'], $e['profile_yellow_h_err']);
      $pairProfileY_Hs[] = $pairProfileY_H;
   }

   // p_max
   $pairPMaxB_V = null;
   if ($e['pmax_blue_v_err'] >= 0)   $pairPMaxB_V = new pair($e['pmax_blue_v'], $e['pmax_blue_v_err']);

   $pairPMaxB_H = null;
   if ($e['pmax_blue_h_err'] >= 0)   $pairPMaxB_H = new pair($e['pmax_blue_h'], $e['pmax_blue_h_err']);

   $pairPMaxY_V = null;
   if ($e['pmax_yellow_v_err'] >= 0) $pairPMaxY_V = new pair($e['pmax_yellow_v'], $e['pmax_yellow_v_err']);

   $pairPMaxY_H = null;
   if ($e['pmax_yellow_h_err'] >= 0) $pairPMaxY_H = new pair($e['pmax_yellow_h'], $e['pmax_yellow_h_err']);


   $pairProfPolarB_V = calcProfPolar($pairPMaxB_V, $pairProfileB_V);
   $pairProfPolarB_H = calcProfPolar($pairPMaxB_H, $pairProfileB_H);
   $pairProfPolarY_V = calcProfPolar($pairPMaxY_V, $pairProfileY_V);
   $pairProfPolarY_H = calcProfPolar($pairPMaxY_H, $pairProfileY_H);

   //$deltaB_prof      = calcMaxDifference($pairB_UD_Avrg, array($pairProfPolarB_V, $pairProfPolarB_H));
   //$deltaY_prof      = calcMaxDifference($pairY_UD_Avrg, array($pairProfPolarY_V, $pairProfPolarY_H));

   //if ($deltaB_prof >= 0)
   //   $deltaB_profs[] = $deltaB_prof;

   //if ($deltaY_prof >= 0)
   //   $deltaY_profs[] = $deltaY_prof;


   $e['pairB_UD_Avrg']    = $pairB_UD_Avrg;
   //$e['deltaB_UvsD']      = $deltaB_UvsD;
   $e['pairY_UD_Avrg']    = $pairY_UD_Avrg;
   //$e['deltaY_UvsD']      = $deltaY_UvsD;

   $e['pairProfileB_V']   = $pairProfileB_V;
   $e['pairProfileB_H']   = $pairProfileB_H;
   $e['pairProfileY_V']   = $pairProfileY_V;
   $e['pairProfileY_H']   = $pairProfileY_H;

   $e['pairPMaxB_V']      = $pairPMaxB_V;
   $e['pairPMaxB_H']      = $pairPMaxB_H;
   $e['pairPMaxY_V']      = $pairPMaxY_V;
   $e['pairPMaxY_H']      = $pairPMaxY_H;

   $e['pairProfPolarB_V'] = $pairProfPolarB_V;
   $e['pairProfPolarB_H'] = $pairProfPolarB_H;
   $e['pairProfPolarY_V'] = $pairProfPolarY_V;
   $e['pairProfPolarY_H'] = $pairProfPolarY_H;

   //$e['deltaB_prof']      = $deltaB_prof;
   //$e['deltaY_prof']      = $deltaY_prof;
}

// this is required due to a php bug
unset($e);

//$deltaB_UvsD_Avrg    = calcQuantileValue($deltaB_UvsDs, .90);
//$deltaY_UvsD_Avrg    = calcQuantileValue($deltaY_UvsDs, .90);

$pairProfileB_V_Avrg = calcWeigtedAvrgErr($pairProfileB_Vs);
$pairProfileB_V_SDev = calcWeigtedStdDev( $pairProfileB_Vs);
$pairProfileB_V_misd = new pair($pairProfileB_V_Avrg->first, $pairProfileB_V_SDev->first);

$pairProfileB_H_Avrg = calcWeigtedAvrgErr($pairProfileB_Hs);
$pairProfileB_H_SDev = calcWeigtedStdDev( $pairProfileB_Hs);
$pairProfileB_H_misd = new pair($pairProfileB_H_Avrg->first, $pairProfileB_H_SDev->first);

$pairProfileY_V_Avrg = calcWeigtedAvrgErr($pairProfileY_Vs);
$pairProfileY_V_SDev = calcWeigtedStdDev( $pairProfileY_Vs);
$pairProfileY_V_misd = new pair($pairProfileY_V_Avrg->first, $pairProfileY_V_SDev->first);

$pairProfileY_H_Avrg = calcWeigtedAvrgErr($pairProfileY_Hs);
$pairProfileY_H_SDev = calcWeigtedStdDev( $pairProfileY_Hs);
$pairProfileY_H_misd = new pair($pairProfileY_H_Avrg->first, $pairProfileY_H_SDev->first);


print("<pre>");
//print_r($deltaB_UvsDs);
//print_r($deltaY_UvsDs);
//print_r($pairProfileB_Vs);
//print_r($pairProfileB_Hs);
print("</pre>");

?>


<p>
<table border="1" cellpadding="4" cellspacing="0" align="center" width="100%">

<?php

$header = "
<tr>
   <th>Fill
<!--   <th>Selected -->

   <th class='bluPol'>Polarization, %<br>In collisions
   <th class='bluPol'>Polarization, %<br>Beam
   <th class='bluPol'>k_{coll}
   <!--<th class='bluPol'>\Delta {U vs. D}, %-->
   <!--<th class='bluPol'>\Delta {R}, %-->

   <th class='yelPol'>Polarization, %<br>In collisions
   <th class='yelPol'>Polarization, %<br>Beam
   <th class='yelPol'>k_{coll}
   <!--<th class='yelPol'>\Delta {U vs. D}, %-->
   <!--<th class='yelPol'>\Delta {R}, %-->

   <th class='bluPol'>Polarization, %<br>H-jet
   <th class='bluPol'>Polarization, %<br>B1U
   <th class='bluPol'>Polarization, %<br>B2D
   <th class='bluPol'>R_H<br>Horiz. profile
   <th class='bluPol'>R_V<br>Vert. profile
<!--   <th class='bluPol'>Polarization, %<br>Horiz. profile-->
<!--   <th class='bluPol'>Polarization, %<br>Vert. profile -->

   <th class='yelPol'>Polarization, %<br>H-jet
   <th class='yelPol'>Polarization, %<br>Y1D
   <th class='yelPol'>Polarization, %<br>Y2U
   <th class='yelPol'>R_H<br>Horiz. profile
   <th class='yelPol'>R_V<br>Vert. profile
<!--   <th class='yelPol'>Polarization, %<br>Horiz. profile-->
<!--   <th class='yelPol'>Polarization, %<br>Vert. profile -->
";

$polarB1Us   = array();
$polarY1Ds   = array();
$polarB2Ds   = array();
$polarY2Us   = array();

$polarBAvrgs = array();
$polarYAvrgs = array();

$polarB_Colls = array();
$polarY_Colls = array();

$iRow = 0;

print("<pre>");
//print_r($es);
//foreach ($es as $e):
//   print ($e['fill']."\n");
//endforeach;
print("</pre>");

// Final loop over over all entries to create table rows
foreach ($es as $e):

   if ($iRow % 50 == 0)
      print $header;

   $pairPolarBHJ = null;
   $pairPolarYHJ = null;
   $pairPolarB1U = null;
   $pairPolarB2D = null;
   $pairPolarY1D = null;
   $pairPolarY2U = null;


   if ($e['polar_blue_hjet_err'] >= 0) {
      $pairPolarBHJ = new pair(           $e['polar_blue_hjet'],              $e['polar_blue_hjet_err']);
   }

   if ($e['polar_yellow_hjet_err'] >= 0) {
      $pairPolarYHJ = new pair(           $e['polar_yellow_hjet'],            $e['polar_yellow_hjet_err']);
   }

   if ($e['polar_blue_1_err'] >= 0) {
      //$pairPolarB1U = new pair($normB1U * $e['polar_blue_1'],      $normB1U * $e['polar_blue_1_err']);
      $pairPolarB1U = new pair($e['polar_blue_1'],      $e['polar_blue_1_err']);
      //if ($e['polar_blue_hjet_err'] >= 0) $polarB1Us[]  = $pairPolarB1U;
      $polarB1Us[] = $pairPolarB1U;
   }

   if ($e['polar_blue_2_err'] >= 0) {
      //$pairPolarB2D = new pair($normB2D * $e['polar_blue_2'],      $normB2D * $e['polar_blue_2_err']);
      $pairPolarB2D = new pair($e['polar_blue_2'],      $e['polar_blue_2_err']);
      //if ($e['polar_blue_hjet_err'] >= 0) $polarB2Ds[]  = $pairPolarB2D;
      $polarB2Ds[] = $pairPolarB2D;
   }

   if ($e['polar_yellow_1_err'] >= 0) {
      //$pairPolarY1D = new pair($normY1D * $e['polar_yellow_1'],    $normY1D * $e['polar_yellow_1_err']);
      $pairPolarY1D = new pair($e['polar_yellow_1'],    $e['polar_yellow_1_err']);
      //if ($e['polar_yellow_hjet_err'] >= 0) $polarY1Ds[]  = $pairPolarY1D;
      $polarY1Ds[] = $pairPolarY1D;
   }

   if ($e['polar_yellow_2_err'] >= 0) {
      //$pairPolarY2U = new pair($normY2U * $e['polar_yellow_2'],    $normY2U * $e['polar_yellow_2_err']);
      $pairPolarY2U = new pair( $e['polar_yellow_2'],    $e['polar_yellow_2_err']);
      //if ($e['polar_yellow_hjet_err'] >= 0) $polarY2Us[]  = $pairPolarY2U;
      $polarY2Us[] = $pairPolarY2U;
   }

   $pairB_UD_Avrg   = $e['pairB_UD_Avrg'];
   //$deltaBUvsD    = $e['deltaB_UvsD'];
   $polarBAvrgs[] = $pairB_UD_Avrg;

   $pairYUDAvrg   = $e['pairY_UD_Avrg'];
   //$deltaYUvsD    = $e['deltaY_UvsD'];
   $polarYAvrgs[] = $pairYUDAvrg;


   // now deal with profiles
   $pairProfileB_V = $e['pairProfileB_V'] !== null ? $e['pairProfileB_V'] : $pairProfileB_V_misd;
   $pairProfileB_H = $e['pairProfileB_H'] !== null ? $e['pairProfileB_H'] : $pairProfileB_H_misd;
   $pairProfileY_V = $e['pairProfileY_V'] !== null ? $e['pairProfileY_V'] : $pairProfileY_V_misd;
   $pairProfileY_H = $e['pairProfileY_H'] !== null ? $e['pairProfileY_H'] : $pairProfileY_H_misd;


   $pairProfPolarB_V = $e['pairProfPolarB_V']; //calcProfPolar($e['pairPMaxB_V'], $e['pairProfileB_V']);
   $pairProfPolarB_H = $e['pairProfPolarB_H']; //calcProfPolar($e['pairPMaxB_H'], $e['pairProfileB_H']);
   $pairProfPolarY_V = $e['pairProfPolarY_V']; //calcProfPolar($e['pairPMaxY_V'], $e['pairProfileY_V']);
   $pairProfPolarY_H = $e['pairProfPolarY_H']; //calcProfPolar($e['pairPMaxY_H'], $e['pairProfileY_H']);

   //$deltaB_prof      = $e['deltaB_prof'];
   //$deltaY_prof      = $e['deltaY_prof'];

   // if both V and H profiles are valid calculate k_coll and its error
   $pairScalePolarBColl = calcPolarCollisionScale($pairProfileB_H, $pairProfileB_V);
   $polarBColl          = calcPolarCollision($pairB_UD_Avrg, $pairScalePolarBColl);
	$polarB_Colls[]      = $polarBColl;

   // if both V and H profiles are valid calculate k_coll and its error
   $pairScalePolarYColl = calcPolarCollisionScale($pairProfileY_H, $pairProfileY_V);
   $polarYColl          = calcPolarCollision($pairYUDAvrg, $pairScalePolarYColl);
	$polarY_Colls[]      = $polarYColl;


   // convert to strings
   //$strDeltaBUvsD = $deltaBUvsD > 0.0000000001 ? sprintf("%5.2f", $deltaBUvsD*100.) : sprintf("<span class='feature'>%5.2f</span>", $deltaB_UvsD_Avrg*100.);
   //$strDeltaYUvsD = $deltaYUvsD > 0.0000000001 ? sprintf("%5.2f", $deltaYUvsD*100.) : sprintf("<span class='feature'>%5.2f</span>", $deltaY_UvsD_Avrg*100.);

   // now profiles
   $strProfileB_V     = $e['pairProfileB_V'] != null ? pairToString($pairProfileB_V) :
                        sprintf("<span class='feature'>%5.2f&nbsp;&plusmn;&nbsp;%5.2f</span>", $pairProfileB_V->first, $pairProfileB_V->second);
   $strProfileB_H     = $e['pairProfileB_H'] != null ? pairToString($pairProfileB_H) :
                        sprintf("<span class='feature'>%5.2f&nbsp;&plusmn;&nbsp;%5.2f</span>", $pairProfileB_H->first, $pairProfileB_H->second);
   $strProfileY_V     = $e['pairProfileY_V'] != null ? pairToString($pairProfileY_V) :
                        sprintf("<span class='feature'>%5.2f&nbsp;&plusmn;&nbsp;%5.2f</span>", $pairProfileY_V->first, $pairProfileY_V->second);
   $strProfileY_H     = $e['pairProfileY_H'] != null ? pairToString($pairProfileY_H) :
                        sprintf("<span class='feature'>%5.2f&nbsp;&plusmn;&nbsp;%5.2f</span>", $pairProfileY_H->first, $pairProfileY_H->second);


   $strProfPolarB_V    = $pairProfPolarB_V != null ? polarPairToString($pairProfPolarB_V) : "&nbsp;";
   $strProfPolarB_H    = $pairProfPolarB_H != null ? polarPairToString($pairProfPolarB_H) : "&nbsp;";
   $strProfPolarY_V    = $pairProfPolarY_V != null ? polarPairToString($pairProfPolarY_V) : "&nbsp;";
   $strProfPolarY_H    = $pairProfPolarY_H != null ? polarPairToString($pairProfPolarY_H) : "&nbsp;";

   //$strDeltaB_prof     = $deltaB_prof > 0.0000000001 ? sprintf("%5.2f", $deltaB_prof*100.) : "&nbsp;";
   //$strDeltaY_prof     = $deltaY_prof > 0.0000000001 ? sprintf("%5.2f", $deltaY_prof*100.) : "&nbsp;";

   $strScalePolarBColl = $pairScalePolarBColl != null ? pairToString($pairScalePolarBColl) : "&nbsp;";
   $strPolarBColl      = $polarBColl != null          ? polarPairToString($polarBColl) : "&nbsp;";
   $strScalePolarYColl = $pairScalePolarYColl != null ? pairToString($pairScalePolarYColl) : "&nbsp;";
   $strPolarYColl      = $polarYColl != null          ? polarPairToString($polarYColl) : "&nbsp;";
?>

<tr>
   <td class=align_cm><a href="http://www.phy.bnl.gov/cnipol/fills/?fillid=<?=$e['fill']?>&ana=run12_e255_testall"><?=$e['fill']?></a>
   <!--<td class=align_cm><input type='checkbox' name='selectedFills[] value=<?=$e['fill']?>'>-->

   <td class='align_cm bluPol'><b><?=$strPolarBColl?></b>
   <td class='align_cm bluPol'><?=polarPairToString($pairB_UD_Avrg)?>
   <td class='align_cm bluPol'><?=$strScalePolarBColl?>
   <!--<td class='align_cm bluPol'><?=$strDeltaBUvsD?>-->
   <!--<td class='align_cm bluPol'><?=$strDeltaB_prof?>-->

   <td class='align_cm yelPol'><b><?=$strPolarYColl?></b>
   <td class='align_cm yelPol'><?=polarPairToString($pairYUDAvrg)?>
   <td class='align_cm yelPol'><?=$strScalePolarYColl?>
   <!--<td class='align_cm yelPol'><?=$strDeltaYUvsD?>-->
   <!--<td class='align_cm yelPol'><?=$strDeltaY_prof?>-->

   <td class=align_cm><?=polarPairToString($pairPolarBHJ)?>
   <td class=align_cm><?=polarPairToString($pairPolarB1U)?>
   <td class=align_cm><?=polarPairToString($pairPolarB2D)?>
   <td class=align_cm><?=$strProfileB_V?>
   <td class=align_cm><?=$strProfileB_H?>
<!--<td class=align_cm><?=$strProfPolarB_V?>-->
<!--<td class=align_cm><?=$strProfPolarB_H?>-->

   <td class=align_cm><?=polarPairToString($pairPolarYHJ)?>
   <td class=align_cm><?=polarPairToString($pairPolarY1D)?>
   <td class=align_cm><?=polarPairToString($pairPolarY2U)?>
   <td class=align_cm><?=$strProfileY_V?>
   <td class=align_cm><?=$strProfileY_H?>
<!--   <td class=align_cm><?=$strProfPolarY_V?>-->
<!--   <td class=align_cm><?=$strProfPolarY_H?>-->

<?php

   $iRow++;

endforeach;


$polarB_Coll_Avrg    = calcWeigtedAvrgErr($polarB_Colls);
$polarBAvrg          = calcWeigtedAvrgErr($polarBAvrgs);

$strPolarB_Coll_Avrg = polarPairToString($polarB_Coll_Avrg);
$strPolarY_Coll_Avrg = polarPairToString(calcWeigtedAvrgErr($polarY_Colls));

$strPolarBAvrg       = polarPairToString($polarBAvrg);
$strPolarYAvrg       = polarPairToString(calcWeigtedAvrgErr($polarYAvrgs));

// calc relative uncertainty
$polarB_Coll_RelErr    = $polarB_Coll_Avrg->first ? $polarB_Coll_Avrg->second/$polarB_Coll_Avrg->first*100. : 0;
$strPolarB_Coll_RelErr = sprintf("%5.2f", $polarB_Coll_RelErr);

$polarBAvrg_RelErr     = $polarBAvrg->first ? $polarBAvrg->second/$polarBAvrg->first*100. : 0;
$strPolarBAvrg_RelErr  = sprintf("%5.2f", $polarBAvrg_RelErr);

?>

<tr>
   <th colspan=22>&nbsp;<br>&nbsp;

<tr>
   <th>Avrg.:

   <th class='bluPol align_ct'><?=$strPolarB_Coll_Avrg?><br><br>\Delta P/P = <?=$strPolarB_Coll_RelErr?> %
   <th class='bluPol align_ct'><?=$strPolarBAvrg?><br><br>\Delta P/P = <?=$strPolarBAvrg_RelErr?> %
   <th class='bluPol'>&nbsp;

   <th class='yelPol align_ct'><?=$strPolarY_Coll_Avrg?>
   <th class='yelPol align_ct'><?=$strPolarYAvrg?>
   <th class='yelPol'>&nbsp;

   <th class=align_ct><?=polarPairToString($pairBHJ_Avrg)?>
   <th class=align_ct><?=polarPairToString($pairB1U_Avrg)?><br><hr>
       <?=polarPairToString($pairBHJ_B1U_Avrg)?>&nbsp;(H-jet|B1U)<br>
       <?=polarPairToString($pairB1U_BHJ_Avrg)?>&nbsp;(B1U|H-jet)<br>
   <th class=align_ct><?=polarPairToString($pairB2D_Avrg)?><br><hr>
       <?=polarPairToString($pairBHJ_B2D_Avrg)?>&nbsp;(H-jet|B2D)<br>
       <?=polarPairToString($pairB2D_BHJ_Avrg)?>&nbsp;(B2D|H-jet)<br>
   <th>&nbsp;
   <th>&nbsp;

   <th class=align_ct><?=polarPairToString($pairYHJ_Avrg)?>
   <th class=align_ct><?=polarPairToString($pairY1D_Avrg)?><br><hr>
       <?=polarPairToString($pairYHJ_Y1D_Avrg)?>&nbsp;(H-jet|Y1D)<br>
       <?=polarPairToString($pairY1D_YHJ_Avrg)?>&nbsp;(Y1D|H-jet)<br>
   <th class=align_ct><?=polarPairToString($pairY2U_Avrg)?><br><hr>
       <?=polarPairToString($pairYHJ_Y2U_Avrg)?>&nbsp;(H-jet|Y2U)<br>
       <?=polarPairToString($pairY2U_YHJ_Avrg)?>&nbsp;(Y2U|H-jet)<br>
   <th>&nbsp;
   <th>&nbsp;

</table>

<p>
Normalization factors for p-Carbon polarization k_{jet/crb} from all fills in this run:

<p>
<table border="1" cellpadding="4" cellspacing="0">
<tr>
   <th class='bluPol'>B1U
   <th class='bluPol'>B2D
   <th class='yelPol'>Y1D
   <th class='yelPol'>Y2U

<tr>
   <td><?=sprintf("%8.7f", $normB1U)?>
   <td><?=sprintf("%8.7f", $normB2D)?>
   <td><?=sprintf("%8.7f", $normY1D)?>
   <td><?=sprintf("%8.7f", $normY2U)?>
</table>


<!-- Main text ends here-->

<?php
include("../bottom.html");
?>

</body>
</html>
